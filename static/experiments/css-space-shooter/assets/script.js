function Alien(e,t,a,s){function n(){return r.motionFunction.call(r)}function i(){r.el.classList.add("hit"),setTimeout(function(){r.destroyed=!0},1200)}function o(){var e=new CustomEvent("miss",{detail:-500});document.dispatchEvent(e)}var r=this,l=1e3,c=-15e3;r.el=e,r.el.classList.add(s.colorClass),r.x=t,r.y=a,r.z=c,r.actualX=t,r.actualY=a,r.lastTimestamp=null,r.motionFunction=s.motionFunction,r.hit=!1,r.destroyed=!1,r.updatePosition=function(e,t,a){var s=n(),d=r.x-e,u=r.y-t,p=Math.min(1-r.z/c/2,1);return r.actualX=s.x,r.actualY=s.y,(null===r.lastTimestamp||100<a-r.lastTimestamp)&&(r.lastTimestamp=a),r.z+=(a-r.lastTimestamp)/1e3*l,r.lastTimestamp=a,r.el.style.transform="translateY("+(s.y+u)+"px) translateX("+(s.x+d)+"px) translateZ("+r.z+"px) ",r.el.style.opacity=p,r.el.style.display="block",r.hit&&i(),500<r.z&&r.hit===!1&&o(),500<r.z||r.destroyed}}function Announcer(e){function t(e){s.container.querySelector(".title").innerHTML="undefined"==typeof e?"":e}function a(e){s.container.querySelector(".subtitle").innerHTML="undefined"==typeof e?"":e}var s=this;s.container=e,s.showMessage=function(e,n){n=n||!1,t(e.title),a(e.subtitle),s.container.classList.add("visible"),n&&setTimeout(function(){s.hideMessage()},2e3)},s.hideMessage=function(){s.container.classList.remove("visible")}}function Simple1DNoise(){for(var e=256,t=e-1,a=1,s=1,n=[],i=0;i<e;++i)n.push(Math.random());var o=function(e){var i=e*s,o=Math.floor(i),l=i-o,c=l*l*(3-2*l),d=o&t,u=d+1&t,p=r(n[d],n[u],c);return p*a},r=function(e,t,a){return e*(1-a)+t*a};return{getVal:o,setAmplitude:function(e){a=e},setScale:function(e){s=e}}}function Sound(e,t){this.context=t,this.buffer=e,this.panner=t.createPanner(),this.gain=t.createGain(),this.playbackRate=1,this.setPannerParameters=function(e){for(var t in e)e.hasOwnProperty(t)&&(this.panner[t]=e[t])},this.setPlaybackRate=function(e){this.playbackRate=e},this.setGain=function(e){this.gain.gain.value=e},this.setPosition=function(e,t,a){this.panner.setPosition(e,t,a)},this.setVelocity=function(e,t,a){},this.play=function(e,t){t=t||!1,this.source=this.context.createBufferSource(),this.source.buffer=this.buffer,this.source.playbackRate.value=this.playbackRate,t&&(this.source.loop=!0),this.source.connect(this.gain),this.gain.connect(this.panner),this.panner.connect(e),this.source.start()},this.stop=function(){this.source.stop()}}function BufferLoader(e,t,a){this.context=e,this.urlList=t,this.onload=a,this.bufferList=[],this.loadCount=0}function Ship(e,t,a){function s(){var e,t=.5;m<o.x&&(e=o.x-m,o.vx-=e*t),o.x<y&&(e=y-o.x,o.vx+=e*t),S<o.y&&(e=o.y-S,o.vy-=e*t),o.y<L&&(e=L-o.y,o.vy+=e*t)}function n(e,t){var a;return a=0<e?e-t:e<0?e+t:e,Math.abs(e)<t&&(a=0),u<a&&(a=u),a<-u&&(a=-u),a}function i(e,t,a,s){var n,i=t-a;return n=0<i?-i*s:i<0?-i*s:e,Math.abs(a-t)<s&&(n=0),p<n&&(n=p),n<-p&&(n=-p),n}var o=this,r=50,l=200,c=100,d=130,u=500,p=200,y=.4*-t,m=.4*t,S=.4*a,L=.4*-a;o.el=e,o.lastTimestamp=null,o.x=0,o.y=100,o.z=0,o.vx=0,o.vy=0,o.rx=90,o.ry=0,o.rz=0,o.vrx=0,o.vry=0,o.vrz=0,o.moveLeft=function(){o.vx+=r,o.vry+=c,o.vrz+=c/2},o.moveRight=function(){o.vx-=r,o.vry-=c,o.vrz-=c/2},o.moveUp=function(){o.vy-=r,o.vrx-=c/1.3},o.moveDown=function(){o.vy+=r,o.vrx+=c/1.3},o.updatePosition=function(e){var t;(null===o.lastTimestamp||100<e-o.lastTimestamp)&&(o.lastTimestamp=e),t=(e-o.lastTimestamp)/1e3,o.lastTimestamp=e,s(),o.x+=o.vx*t,o.y+=o.vy*t,o.ry+=o.vry*t,o.rz+=o.vrz*t,o.rx+=o.vrx*t,o.vx=n(o.vx,l*t),o.vy=n(o.vy,l*t),o.vrx=i(o.vrx,o.rx,90,d*t),o.vry=i(o.vry,o.ry,0,d*t),o.vrz=i(o.vrz,o.rz,0,d*t),o.el.style.transform="translateZ("+o.z+"px) translateX("+o.x+"px) translateY("+o.y+"px) rotateX("+o.rx+"deg) rotateY("+o.ry+"deg) rotateZ("+o.rz+"deg) "}}function Shot(e,t,a){var s=this,n=15e3,i=5e3;s.lastTimestamp=null,s.el=e,s.x=t,s.y=a,s.z=0,s.hit=!1,s.updatePosition=function(e,t,a){(null===s.lastTimestamp||100<a-s.lastTimestamp)&&(s.lastTimestamp=a),s.z-=(a-s.lastTimestamp)/1e3*i,s.lastTimestamp=a;var o=s.x-e,r=s.y-t,l=(n+s.z)/n;return s.el.style.transform="translateY("+(s.y+r)+"px) translateX("+(s.x+o)+"px) translateZ("+s.z+"px) rotateX(90deg)",s.el.style.opacity=l,s.z<-n||s.hit}}function throttle(e,t){canFire&&(e(),canFire=!1,timer=setTimeout(function(){canFire=!0},t))}function Track(e){var t=this;t.container=e,this.start=function(){[].forEach.call(t.container.querySelectorAll(".track"),function(e){e.style.webkitAnimationPlayState="running",e.style.animationPlayState="running"})},this.stop=function(){[].forEach.call(t.container.querySelectorAll(".track"),function(e){e.style.webkitAnimationPlayState="paused",e.style.animationPlayState="paused"})},this.update=function(e){var a=e.x*-.3,s=e.y*-.3;t.container.style.transform="translateX("+a+"px) translateY("+s+"px)"},this.stop()}function SoundCloudAudioSource(e){var t,a=this,s=new(window.AudioContext||window.webkitAudioContext);t=s.createAnalyser(),t.fftSize=256;var n=s.createMediaElementSource(e);n.connect(t),t.connect(s.destination);var i=function(){t.getByteFrequencyData(a.streamData);for(var e=0,s=0;s<80;s++)e+=a.streamData[s];a.volume=e};setInterval(i,20),this.volume=0,this.streamData=new Uint8Array(128),this.playStream=function(t){e.addEventListener("ended",function(){a.directStream("coasting")}),e.setAttribute("src",t),e.play()}}function SoundcloudLoader(e){var t=this,a=SOUNDCLOUD_ID;this.sound={},this.streamUrl="",this.errorMessage="",this.player=e,this.successfullyLoaded=!1,this.loadStream=function(e,s,n){"undefined"!=typeof SC?(SC.initialize({client_id:a}),SC.get("/resolve",{url:e},function(e){if(e)if(e.errors){t.errorMessage="";for(var i=0;i<e.errors.length;i++)t.errorMessage+=e.errors[i].error_message+"<br>";t.errorMessage+="Make sure the URL has the correct format: https://soundcloud.com/user/title-of-the-track",n()}else t.successfullyLoaded=!0,console.log("music loaded"),"playlist"==e.kind?(t.sound=e,t.streamPlaylistIndex=0,t.streamUrl=function(){return e.tracks[t.streamPlaylistIndex].stream_url+"?client_id="+a},s()):(t.sound=e,t.streamUrl=function(){return e.stream_url+"?client_id="+a},s());else console.log("An unspecified error occurred. No music could be loaded"),s()})):(console.log("SoundCloud library not found. No music could be loaded"),s())},this.directStream=function(e){"toggle"==e?this.player.paused?this.player.play():this.player.pause():"playlist"==this.sound.kind&&("coasting"==e?this.streamPlaylistIndex++:"forward"==e?this.streamPlaylistIndex>=this.sound.track_count-1?this.streamPlaylistIndex=0:this.streamPlaylistIndex++:this.streamPlaylistIndex<=0?this.streamPlaylistIndex=this.sound.track_count-1:this.streamPlaylistIndex--,this.streamPlaylistIndex>=0&&this.streamPlaylistIndex<=this.sound.track_count-1&&(this.player.setAttribute("src",this.streamUrl()),this.player.play()))}}function MP3AudioSource(e){var t,a=this,s=new(window.AudioContext||window.webkitAudioContext);t=s.createAnalyser(),t.fftSize=256;var n=s.createMediaElementSource(e);n.connect(t),t.connect(s.destination);var i=function(){t.getByteFrequencyData(a.streamData);for(var e=0,s=0;s<80;s++)e+=a.streamData[s];a.volume=e};setInterval(i,20),this.volume=0,this.streamData=new Uint8Array(128),this.playStream=function(t){e.addEventListener("ended",function(){e.play()}),e.setAttribute("src",t),e.play()}}function MP3Loader(e){var t=this;this.sound={},this.streamUrl=function(){return""},this.errorMessage="",this.player=e,this.successfullyLoaded=!1,this.loadStream=function(e,a,s){t.successfullyLoaded=!0,this.streamUrl=function(){return e},a()}}function init(){game.init(function(){console.log("game loaded"),music.load("./assets/sfx/music.mp3",function(){document.querySelector(".loader").classList.add("hidden"),registerEventHandlers()}),visualizer.setElement(document.querySelector(".visualizer"))}),game.onCompleted(function(){document.querySelector(".game-over-container").classList.remove("hidden"),document.querySelector(".game-won").classList.remove("hidden"),fillInScoreCard()}),game.onDied(function(){document.querySelector(".game-over-container").classList.remove("hidden"),document.querySelector(".game-lost").classList.remove("hidden"),fillInScoreCard()})}function fillInScoreCard(){var e=game.getScoreCardInfo(),t=localStorage.bestScore,a=localStorage.bestStage;("undefined"==typeof t||parseInt(t.replace(",",""),10)<parseInt(e.score.replace(",",""),10))&&(document.querySelector(".new-record.score").style.display="inline",localStorage.bestScore=t=e.score),("undefined"==typeof a||a<e.stage)&&(document.querySelector(".new-record.stage").style.display="inline",localStorage.bestStage=a=e.stage),document.querySelector(".stage-reached").innerText=e.stage,document.querySelector(".best-stage").innerText=a||e.stage,document.querySelector(".score-achieved").innerText=e.score,document.querySelector(".best-score").innerText=t||e.score}function registerEventHandlers(){document.addEventListener("keydown",function(e){var t=e.which;32===t&&"initialized"===game.state()&&(document.querySelector(".browser-warning").style.display="none",game.start(),music.play(),visualizer.start(music),document.querySelector(".title-screen-container").classList.add("hidden")),80===t&&("paused"===game.state()?(game.resume(),music.resume()):(game.pause(),music.pause())),82===t&&("won"!==game.state()&&"lost"!==game.state()||document.location.reload())});var e=document.querySelector(".instructions"),t=document.querySelector(".about");e.querySelector(".open-instructions").addEventListener("click",function(t){e.classList.add("display"),t.preventDefault()}),e.querySelector(".close-instructions").addEventListener("click",function(t){e.classList.remove("display"),t.preventDefault()}),t.querySelector(".open-about").addEventListener("click",function(e){t.classList.add("display"),e.preventDefault()}),t.querySelector(".close-about").addEventListener("click",function(e){t.classList.remove("display"),e.preventDefault()})}var alienFactory=function(){function e(e){var t,a,i=function(){return{x:this.x,y:this.y}},o=function(e){return function(){var t=this.y+Math.sin(this.z/1e3*e)*n/4,a=this.x;return{x:a,y:t}}},r=function(e){return function(){var t=this.y,a=this.x+Math.sin(this.z/1e3*e)*s/4;return{x:a,y:t}}},l=function(e){return function(){var t=this.y+Math.cos(this.z/1e3*e)*s/4,a=this.x+Math.sin(this.z/1e3*e)*s/4;return{x:a,y:t}}},c=function(e){var t=new Simple1DNoise;t.setAmplitude(s/2);var a=new Simple1DNoise;return a.setAmplitude(n/2),function(){var s=this.y+a.getVal(this.z/1e3*e),n=this.x+t.getVal(this.z/1e3*e);return{x:n,y:s}}};return e["class"]===ALIEN_CLASS.stationary?(t=i,a="orange"):e["class"]===ALIEN_CLASS.vertical?(t=o(e.speed),a="red"):e["class"]===ALIEN_CLASS.horizontal?(t=r(e.speed),a="blue"):e["class"]===ALIEN_CLASS.spiral?(t=l(e.speed),a="green"):e["class"]===ALIEN_CLASS.random&&(t=c(e.speed),a="white"),{motionFunction:t,colorClass:a}}var t,a=[],s=document.documentElement.clientWidth,n=document.documentElement.clientHeight;return{setTemplate:function(e){t=e.cloneNode(!0)},spawn:function(i){i.type&&"spawn"===i.type&&i.data.forEach(function(i){var o=t.cloneNode(!0),r=s*(Math.random()-.5)*.7,l=n*(Math.random()-.5)*.5,c=document.querySelector(".scene"),d=e(i);c.insertBefore(o,c.children[0]),a.push(new Alien(o,r,l,d))})},updatePositions:function(e,t){var s,n,i,o=[];for(i=0;i<a.length;i++)n=a[i].updatePosition(e.x,e.y,t),n&&o.push(i);for(i=o.length-1;i>=0;--i){s=a[o[i]].el;var r=a.splice(o[i],1);r[0].sound.stop(),document.querySelector(".scene").removeChild(s)}return o.length},aliens:function(){return a}}}(),collisionDetector=function(){function e(e,a){var s,n;return Math.abs(a.z-e.z)<o&&(s=t(r,e.z),n=t(l,e.z),Math.abs(a.x-e.actualX)<s&&Math.abs(a.y-e.actualY)<n)}function t(e,t){var a=(t+15e3)/1500;return e*(1+a)}function a(e){var t=new CustomEvent("hit",{detail:{x:e.x,y:e.y,z:e.z}});document.dispatchEvent(t)}var s={},n=document.documentElement.clientWidth,i=document.documentElement.clientHeight,o=100,r=.01*n,l=.01*i;return s.check=function(t,s){s.forEach(function(s){t.forEach(function(t){e(s,t)&&(s.hit||(s.hit=!0,a(s)),t.hit=!0)})})},s}(),display=function(){var e,t,a,s,n={};return n.setAnnouncerElement=function(t){e=new Announcer(t)},n.setFirepowerElement=function(e){t=e},n.setScoreElement=function(e){a=e},n.setLivesElement=function(e){s=e},n.hideAll=function(){t.classList.add("hidden"),a.parentElement.classList.add("hidden"),s.classList.add("hidden")},n.showAll=function(){t.classList.remove("hidden"),a.parentElement.classList.remove("hidden"),s.classList.remove("hidden")},n.update=function(s,n,i){s.type&&"announcement"===s.type&&e.showMessage(s.data,!0),t.style.width=30*n+"px",a.innerHTML=Math.round(i).toLocaleString()},n.showPausedMessage=function(){e.showMessage({title:"Paused",subtitle:'Press "p" to resume'})},n.hidePausedMessage=function(){e.hideMessage()},n.updateLives=function(e){var t,a=3;for(t=a;t>0;t--)t<=e?s.children[t-1].classList.remove("hidden"):s.children[t-1].classList.add("hidden")},n}(),levelPlayer=function(){function e(e){return("undefined"==typeof i||100<e-i)&&(i=e),l+=e-i,i=e,Math.floor(l/1e3)}function t(){return a()&&0===c&&(d<o.length-1?(d++,c=0,l=0):u=!0),o[d]}function a(){var e=o[d].events;return e[e.length-1].fired===!0}function s(e,t){var a,s;if(u)return{type:"completed"};for(a=0;a<t.events.length;a++)if(s=t.events[a],s.time===e&&!s.fired)return s.fired=!0,n(s),s;return{}}function n(e){"spawn"===e.type&&(c+=e.data.length)}var i,o,r={},l=0,c=0,d=0,u=!1;return r.setLevel=function(e){o=JSON.parse(JSON.stringify(e))},r.getEvents=function(a){var n;n=t();var i=e(a);return s(i,n)},r.alienRemoved=function(){c=Math.max(c-1,0)},r.getCurrentStage=function(){return Math.round(d+1)},r}(),ALIEN_CLASS={stationary:1,vertical:2,horizontal:3,spiral:4,random:5},levelData=[{events:[{time:2,type:"announcement",data:{title:"Stage 1",subtitle:"Flight School!"}},{time:11,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]}]},{events:[{time:2,type:"announcement",data:{title:"Stage 2",subtitle:"Warm-up!"}},{time:3,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:7,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:11,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:16,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1},{"class":ALIEN_CLASS.stationary,speed:1}]}]},{events:[{time:2,type:"announcement",data:{title:"Stage 3",subtitle:"Ready?"}},{time:3,type:"spawn",data:[{"class":ALIEN_CLASS.vertical,speed:1}]},{time:6,type:"spawn",data:[{"class":ALIEN_CLASS.horizontal,speed:1}]},{time:9,type:"spawn",data:[{"class":ALIEN_CLASS.vertical,speed:1},{"class":ALIEN_CLASS.stationary,speed:1}]},{time:13,type:"spawn",data:[{"class":ALIEN_CLASS.horizontal,speed:1},{"class":ALIEN_CLASS.stationary,speed:1}]},{time:17,type:"spawn",data:[{"class":ALIEN_CLASS.vertical,speed:1.5},{"class":ALIEN_CLASS.horizontal,speed:1.5}]}]},{events:[{time:2,type:"announcement",data:{title:"Stage 4",subtitle:"Spirals!"}},{time:3,type:"spawn",data:[{"class":ALIEN_CLASS.spiral,speed:1}]},{time:7,type:"spawn",data:[{"class":ALIEN_CLASS.spiral,speed:1}]},{time:11,type:"spawn",data:[{"class":ALIEN_CLASS.spiral,speed:1}]},{time:15,type:"spawn",data:[{"class":ALIEN_CLASS.spiral,speed:2}]},{time:16,type:"spawn",data:[{"class":ALIEN_CLASS.spiral,speed:2}]}]},{events:[{time:2,type:"announcement",data:{title:"Stage 5",subtitle:"Turkey Shoot!"}},{time:3,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:4,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:5,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:6,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:7,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:8,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:8,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:9,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:10,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:11,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:12,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:13,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:14,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1},{"class":ALIEN_CLASS.stationary,speed:1}]},{time:15,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1},{"class":ALIEN_CLASS.stationary,speed:1}]},{time:16,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1},{"class":ALIEN_CLASS.stationary,speed:1}]},{time:17,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1},{"class":ALIEN_CLASS.stationary,speed:1}]},{time:18,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1},{"class":ALIEN_CLASS.stationary,speed:1}]}]},{events:[{time:2,type:"announcement",data:{title:"Stage 6",subtitle:"Catch Me If You Can!"}},{time:3,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:1}]},{time:8,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:3}]},{time:12,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:5}]}]},{events:[{time:2,type:"announcement",data:{title:"Stage 7",subtitle:"A bit of everything!"}},{time:3,type:"spawn",data:[{"class":ALIEN_CLASS.horizontal,speed:2}]},{time:5,type:"spawn",data:[{"class":ALIEN_CLASS.vertical,speed:2}]},{time:7,type:"spawn",data:[{"class":ALIEN_CLASS.spiral,speed:2}]},{time:9,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:11,type:"spawn",data:[{"class":ALIEN_CLASS.vertical,speed:3}]},{time:14,type:"spawn",data:[{"class":ALIEN_CLASS.horizontal,speed:3}]},{time:17,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:1}]},{time:20,type:"spawn",data:[{"class":ALIEN_CLASS.spiral,speed:2},{"class":ALIEN_CLASS.spiral,speed:3}]}]},{events:[{time:2,type:"announcement",data:{title:"Stage 8",subtitle:"Don't Panic!"}},{time:3,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:3}]},{time:6,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:3}]},{time:7,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:4}]},{time:9,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:4}]},{time:15,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:5}]},{time:17,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:5}]},{time:19,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:5}]},{time:20,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:5}]},{time:21,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:5}]}]},{events:[{time:2,type:"announcement",data:{title:"Stage 9",subtitle:"Hang In There!"}},{time:3,type:"spawn",data:[{"class":ALIEN_CLASS.horizontal,speed:3},{"class":ALIEN_CLASS.vertical,speed:3}]},{time:6,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:3},{"class":ALIEN_CLASS.spiral,speed:3}]},{time:9,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:2},{"class":ALIEN_CLASS.random,speed:4}]},{time:11,type:"spawn",data:[{"class":ALIEN_CLASS.horizontal,speed:4},{"class":ALIEN_CLASS.random,speed:3}]},{time:13,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:3},{"class":ALIEN_CLASS.stationary,speed:3}]},{time:14,type:"spawn",data:[{"class":ALIEN_CLASS.spiral,speed:3},{"class":ALIEN_CLASS.stationary,speed:3},{"class":ALIEN_CLASS.spiral,speed:5}]},{time:15,type:"spawn",data:[{"class":ALIEN_CLASS.horizontal,speed:4},{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.vertical,speed:3}]},{time:16,type:"spawn",data:[{"class":ALIEN_CLASS.vertical,speed:3},{"class":ALIEN_CLASS.random,speed:3},{"class":ALIEN_CLASS.stationary,speed:3}]},{time:21,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:3},{"class":ALIEN_CLASS.stationary,speed:3},{"class":ALIEN_CLASS.spiral,speed:3},{"class":ALIEN_CLASS.stationary,speed:3}]},{time:22,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:4},{"class":ALIEN_CLASS.random,speed:4},{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.spiral,speed:4}]},{time:23,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:4},{"class":ALIEN_CLASS.random,speed:4},{"class":ALIEN_CLASS.spiral,speed:4}]},{time:26,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:4},{"class":ALIEN_CLASS.random,speed:4},{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.spiral,speed:4}]}]},{events:[{time:2,type:"announcement",data:{title:"Stage 10",subtitle:"Final Stage!"}},{time:3,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:3}]},{time:8,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:3}]},{time:12,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:4}]},{time:15,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.stationary,speed:4}]},{time:18,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.stationary,speed:4}]},{time:22,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.stationary,speed:4}]},{time:25,type:"spawn",data:[{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.stationary,speed:4},{"class":ALIEN_CLASS.stationary,speed:4}]},{time:30,type:"spawn",data:[{"class":ALIEN_CLASS.vertical,speed:1},{"class":ALIEN_CLASS.horizontal,speed:1},{"class":ALIEN_CLASS.vertical,speed:5},{"class":ALIEN_CLASS.horizontal,speed:5}]},{time:35,type:"spawn",data:[{"class":ALIEN_CLASS.vertical,speed:1},{"class":ALIEN_CLASS.horizontal,speed:1},{"class":ALIEN_CLASS.vertical,speed:2},{"class":ALIEN_CLASS.spiral,speed:2}]},{time:40,type:"spawn",data:[{"class":ALIEN_CLASS.spiral,speed:1},{"class":ALIEN_CLASS.vertical,speed:1},{"class":ALIEN_CLASS.vertical,speed:3},{"class":ALIEN_CLASS.spiral,speed:5}]},{time:45,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:1}]},{time:46,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:1}]},{time:47,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:2}]},{time:48,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:2}]},{time:49,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:3}]},{time:50,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:3}]},{time:51,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:4}]},{time:52,type:"spawn",data:[{"class":ALIEN_CLASS.random,speed:5}]}]}],sfx=function(){var e={};window.AudioContext=window.AudioContext||window.webkitAudioContext;var t=new AudioContext,a=t.createGain();return a.connect(t.destination),e.sounds={},e.loadSounds=function(s){function n(n){var i=new Sound(n[0],t),o=new Sound(n[1],t),r=new Sound(n[2],t),l=new Sound(n[3],t),c=new Sound(n[5],t);r.setGain(2),l.setGain(2),i.setPannerParameters({coneOuterGain:.9,coneOuterAngle:40,coneInnerAngle:0,rolloffFactor:.1}),i.setGain(.1),o.setPannerParameters({coneOuterGain:1,coneOuterAngle:360,coneInnerAngle:0,rolloffFactor:.3}),o.setGain(2.5),e.sounds={gun:{play:function(e,t){x=e.x/100,y=e.y/100,vx=e.vx/5,vy=e.vy/5,i.setPosition(x,y,-3);var s=.5+t/20;i.setPlaybackRate(s),i.play(a)}},ship:{play:function(e,t){e/=100,t/=100,o.setPosition(e,t,-3),o.play(a,!0)},setParameters:function(e,t,a,s){e/=50,t/=50,a/=10,s/=10,o.setPosition(e,t,-3)}},explosion:{play:function(e,t,s){e/=100,t/=100,s/=1e3,r.setPosition(e,t,s),r.play(a)}},alien:{play:function(e,t,s){e/=100,t/=100,s/=1e3,l.setPosition(e,t,s),l.play(a)}},alienDrone:{create:function(){var e=new Sound(n[4],t);return e.setPannerParameters({coneOuterGain:.1,coneOuterAngle:90,coneInnerAngle:0,rolloffFactor:2}),e.setGain(1.5),e.play(a,!0),e},setParameters:function(e,t,a){x=(t.x-a.x)/100,y=(t.y-a.y)/100,z=t.z/1e3,e.setPosition(x,y,z)}},alarm:{play:function(){c.play(a)}}},s()}var i=new BufferLoader(t,["assets/sfx/gun.mp3","assets/sfx/ship_drone.mp3","assets/sfx/explosion.mp3","assets/sfx/alien.mp3","assets/sfx/alien_drone.mp3","assets/sfx/alarm.mp3"],n);i.load()},e.setGain=function(e){a.gain.value=e},e}();BufferLoader.prototype.loadBuffer=function(e,t){var a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="arraybuffer";var s=this;a.onload=function(){s.context.decodeAudioData(a.response,function(a){return a?(s.bufferList[t]=a,void(++s.loadCount==s.urlList.length&&s.onload(s.bufferList))):void alert("error decoding file data: "+e)},function(e){console.error("decodeAudioData error",e)})},a.onerror=function(){alert("BufferLoader: XHR error")},a.send()},BufferLoader.prototype.load=function(){for(var e=0;e<this.urlList.length;++e)this.loadBuffer(this.urlList[e],e)};var shotFactory=function(){function e(e){(null===r||100<e-r)&&(r=e);var t=(e-r)/1e3;o<s&&(o+=t*n),r=e}function t(e,t){var a=new CustomEvent("shot",{detail:{firepower:o}});document.dispatchEvent(a)}var a,s=10,n=4,i=[],o=s,r=null;return{setTemplate:function(e){a=e.cloneNode(!1),a.style.display="block"},create:function(e){0<Math.round(o)&&throttle(function(){if(3<o){var s=.03*document.documentElement.clientWidth,n={x:e.x-s*Math.cos(e.ry*(Math.PI/180)),y:e.y-Math.tan(e.ry*(Math.PI/180))*s},r={x:e.x+s*Math.cos(e.ry*(Math.PI/180)),y:e.y+Math.tan(e.ry*(Math.PI/180))*s},l=a.cloneNode(!1);document.querySelector(".scene").appendChild(l),i.push(new Shot(l,n.x,n.y));var c=a.cloneNode(!1);document.querySelector(".scene").appendChild(c),i.push(new Shot(c,r.x,r.y))}else{var d=a.cloneNode(!1);document.querySelector(".scene").appendChild(d),i.push(new Shot(d,e.x,e.y))}t(e.x,e.y),o--},150)},updatePositions:function(t,a){var s,n,o=[];for(n=0;n<i.length;n++)s=i[n].updatePosition(t.x,t.y,a),s&&o.push(n);for(n=o.length-1;n>=0;--n){var r=i[o[n]].el;i.splice(o[n],1),document.querySelector(".scene").removeChild(r)}e(a)},shots:function(){return i},firepower:function(){return o}}}(),timer,canFire=!0,visualizer=function(){function e(e,t,a){for(var s=0,n=t;n<=a;n++)s+=e[n];return s/(a-t)}var t,a,s={};return s.setElement=function(e){t=e.querySelector(".highs"),a=e.querySelector(".lows"),t.style.opacity=0,a.style.opacity=0},s.start=function(s){function n(){var i=s.getAudioData().frequencyData,o=e(i,0,15)/255,r=e(i,16,25)/255;a.style.opacity=o,t.style.opacity=r,setTimeout(n,300)}n()},s}(),music=function(){var e={},t=document.getElementById("player"),a=new MP3Loader(t),s=new MP3AudioSource(t);return e.load=function(e,t){t=t||function(){},a.loadStream(e,t,function(){console.log("Error: ",a.errorMessage)})},e.play=function(){a.successfullyLoaded&&s.playStream(a.streamUrl())},e.pause=function(){t.pause()},e.resume=function(){t.play()},e.getAudioData=function(){return{volume:s.volume,frequencyData:s.streamData}},e}(),game=function(){function e(s){var n;m||(o.x=A,o.y=h),m&&!L&&(0<y.length&&(y.indexOf(39)!==-1&&o.moveLeft(),y.indexOf(37)!==-1&&o.moveRight(),y.indexOf(38)!==-1&&o.moveUp(),y.indexOf(40)!==-1&&o.moveDown(),y.indexOf(32)!==-1&&shotFactory.create(o)),n=levelPlayer.getEvents(s),alienFactory.spawn(n),display.update(n,shotFactory.firepower(),u),t()),o.updatePosition(s),r.update(o),shotFactory.updatePositions(o,s),alienFactory.updatePositions(o,s),collisionDetector.check(shotFactory.shots(),alienFactory.aliens()),a(n,p),S||window.requestAnimationFrame(e)}function t(){if(sfx.sounds.ship.setParameters(o.x,o.y,o.vx,o.vy),Math.random()<.001){var e=alienFactory.aliens();if(0<e.length){var t=e[Math.floor(Math.random()*e.length)];sfx.sounds.alien.play(t.x,t.y,t.z)}}alienFactory.aliens().forEach(function(e){"undefined"==typeof e.sound&&(e.sound=sfx.sounds.alienDrone.create()),sfx.sounds.alienDrone.setParameters(e.sound,e,o)})}function a(e,t){e&&"completed"===e.type&&(f||(l(),f=!0)),0===t&&(L||(c(),L=!0))}function s(){document.body.style.cursor="none"}function n(){document.body.style.cursor="inherit"}function i(){document.addEventListener("keydown",function(e){var t=e.which;y.indexOf(t)===-1&&(y.push(t),65===t&&alienFactory.spawn())}),document.addEventListener("keyup",function(e){var t=e.which;y.splice(y.indexOf(t),1)}),document.addEventListener("hit",function(e){var t=e.detail;u+=100*shotFactory.firepower(),levelPlayer.alienRemoved(),sfx.sounds.explosion.play(t.x,t.y,t.z)}),document.addEventListener("shot",function(e){sfx.sounds.gun.play(o,e.detail.firepower)}),document.addEventListener("miss",function(e){0<p&&(p--,display.updateLives(p),sfx.sounds.alarm.play()),levelPlayer.alienRemoved()})}var o,r,l,c,d={},u=0,p=3,y=[],m=!1,S=!1,L=!1,f=!1,A=3e3,h=6e3;return d.init=function(t){o=new Ship(document.querySelector(".ship-container"),document.documentElement.clientWidth,document.documentElement.clientHeight),o.y=h,o.x=A,r=new Track(document.querySelector(".midground")),display.setAnnouncerElement(document.querySelector(".announcement")),display.setFirepowerElement(document.querySelector(".firepower-meter-container")),display.setScoreElement(document.querySelector(".score")),display.setLivesElement(document.querySelector(".lives-container")),shotFactory.setTemplate(document.querySelector(".shot")),alienFactory.setTemplate(document.querySelector(".alien-container")),levelPlayer.setLevel(levelData),sfx.loadSounds(function(){t()}),window.requestAnimationFrame(e)},d.onCompleted=function(e){l=e},d.onDied=function(e){c=e},d.start=function(){m=!0,display.showAll(),sfx.sounds.ship.play(o.x,o.y),setTimeout(r.start,1e3),i(),s()},d.pause=function(){S=!0,display.showPausedMessage(),r.stop(),sfx.setGain(0),n()},d.resume=function(){S=!1,display.hidePausedMessage(),r.start(),sfx.setGain(1),s(),requestAnimationFrame(e)},d.state=function(){var e;return e=f?"won":L?"lost":m?S?"paused":"running":"initialized"},d.getScoreCardInfo=function(){return{score:Math.round(u).toLocaleString(),stage:levelPlayer.getCurrentStage()}},d}();init();